<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>지원 페이지</title>
  <style>
    :root { --gap: 12px; --w: 840px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#fafafa; color:#111; }
    .wrap { max-width: var(--w); margin: 24px auto 80px; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
    .head-img { width:100%; height: 220px; object-fit: cover; border-radius: 12px; background:#f3f4f6; }
    .h1 { font-size: 22px; font-weight: 700; margin: 18px 0 10px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .field { display:flex; flex-direction:column; gap:6px; }
    .label { font-weight:600; font-size: 14px; }
    .input, .textarea { border:1px solid #d1d5db; border-radius:10px; padding: 10px 12px; font-size:14px; background:#fff; }
    .row { display:flex; gap: var(--gap); flex-wrap:wrap; align-items:center; }
    .btn { border:1px solid #e5e7eb; background:#111; color:#fff; padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:600; font-size:14px; }
    .btn.outline { background:#fff; color:#111; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .bar { display:flex; justify-content:space-between; gap:8px; padding:16px; border-top:1px solid #eee; align-items:center; }
    .section { padding:18px; }
    .muted { color:#6b7280; font-size:12px; }
    .toast { position: fixed; right: 16px; bottom: 16px; background:#111; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transform: translateY(8px); transition: all .25s; }
    .toast.show { opacity:1; transform: translateY(0); }
    .center { display:flex; align-items:center; justify-content:center; min-height: 60vh; }
    .hidden { display:none !important; }
    @media(max-width:720px){ .grid { grid-template-columns: 1fr; } .head-img{ height: 160px; } }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <!-- 로그인 화면 -->
    <div id="loginView" class="card">
      <div class="section">
        <div class="h1">로그인이 필요합니다</div>
        <div class="muted" style="margin-bottom:16px">Google 계정으로 로그인 후 지원서를 작성할 수 있습니다.</div>
        <div class="center" style="padding-bottom:24px">
          <div id="gsi_btn_container"></div>
        </div>
      </div>
    </div>

    <!-- 앱 화면 -->
    <div id="appView" class="card hidden">
      <div class="section">
        <!-- 외부 이미지 차단 방지 -->
        <img id="headerImage" class="head-img" alt="header" referrerpolicy="no-referrer" />
        <div class="row" style="justify-content:space-between; margin-top:8px;">
          <div>
            <div class="h1">지원 정보 입력</div>
            <div class="muted">로그인 완료 후 항목을 입력해 주세요. 중간저장 가능하며, 최종제출 시 수정이 제한될 수 있습니다.</div>
          </div>
          <div class="muted" id="loginInfo" style="text-align:right"></div>
        </div>
      </div>
      <div class="section">
        <form id="applyForm">
          <div id="fields" class="grid"></div>
        </form>
      </div>
      <div class="bar">
        <div class="row" style="gap:8px">
          <button id="btnDraft" class="btn outline" type="button">중간저장</button>
          <button id="btnSubmit" class="btn" type="button">최종제출</button>
        </div>
        <button id="btnSignOut" class="btn outline" type="button">로그아웃</button>
      </div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script>
    /*** 환경변수 ***/
    const GOOGLE_CLIENT_ID = '1035171128477-4jfnu5mq44uof62d1bssq547c9fnn5jl.apps.googleusercontent.com';
    const GAS_BASE_URL     = '/api/gas';

    /*** 유틸 ***/
    async function safeJson(r){
      const t = await r.text();
      try { return JSON.parse(t); } catch(e){ console.error('Non-JSON:', t); throw e; }
    }

    /*** 상태/헬퍼 ***/
    const $ = (sel) => document.querySelector(sel);
    function toast(msg){ const el=$('#toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); }
    function disableButtons(dis){ $('#btnDraft').disabled=dis; $('#btnSubmit').disabled=dis; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ✅ 한글 깨짐 방지: JWT UTF-8 디코드
    function decodeJwt(token){
      const b64 = token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
      const bin = atob(b64);
      try {
        const json = new TextDecoder().decode(Uint8Array.from(bin, c => c.charCodeAt(0)));
        return JSON.parse(json);
      } catch {
        const json = decodeURIComponent(bin.split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(json);
      }
    }

    let LOGIN = { id:'', name:'', email:'', picture:'' };
    let CONFIG_FIELDS = [];
    let CONFIG_IMAGE = '';

    /*** 뷰 전환 ***/
    function showLogin(){ $('#loginView').classList.remove('hidden'); $('#appView').classList.add('hidden'); }
    function showApp(){   $('#loginView').classList.add('hidden');    $('#appView').classList.remove('hidden'); }

    function persistLogin(){ localStorage.setItem('resume.login', JSON.stringify(LOGIN)); }
    function loadPersistedLogin(){
      try{ const s = localStorage.getItem('resume.login'); if(!s) return null; const o = JSON.parse(s); if(o && o.email) return o; }catch(_){}
      return null;
    }
    function signOut(){
      localStorage.removeItem('resume.login');
      LOGIN = { id:'', name:'', email:'', picture:'' };
      showLogin();
    }

    /*** GIS 초기화 ***/
    window.onload = () => {
      const saved = loadPersistedLogin();
      if (saved) { LOGIN = saved; afterLogin(); } else { showLogin(); }

      window.google?.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (resp) => {
          try{
            const payload = decodeJwt(resp.credential);
            LOGIN = {
              id: payload.sub,
              name: payload.name || '',
              email: payload.email || '',
              picture: payload.picture || ''
            };
            persistLogin();
            afterLogin();
          }catch(e){ console.error(e); toast('로그인에 실패했습니다.'); }
        },
        auto_select: false,
        ux_mode: 'popup'
      });
      window.google?.accounts.id.renderButton(
        document.getElementById('gsi_btn_container'),
        { type:'standard', theme:'outline', size:'large', text:'continue_with', shape:'pill' }
      );
    };

    /*** 서버 통신
     *  - config: 캐시 허용(서버가 60초 캐시 설정)
     *  - draft: 항상 최신 (no-store), 캐시버스터 파라미터로 확실히
     */
    async function fetchConfig(){
      const r = await fetch(`${GAS_BASE_URL}?action=config`, { cache: 'default' });
      if(!r.ok) throw new Error(`config 실패 (${r.status})`);
      return safeJson(r);
    }
    async function fetchDraft(loginId){
      const r = await fetch(`${GAS_BASE_URL}?action=getDraft&loginId=${encodeURIComponent(loginId)}&_t=${Date.now()}`, { cache: 'no-store' });
      if(!r.ok) throw new Error(`draft 실패 (${r.status})`);
      return safeJson(r);
    }
    async function postAction(action, loginId, fields, values){
      const body = new URLSearchParams();
      body.set('action', action);
      body.set('loginId', loginId);
      body.set('fieldsJson', JSON.stringify(fields));
      body.set('valuesJson', JSON.stringify(values));
      const r = await fetch(GAS_BASE_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      if(!r.ok) throw new Error(action+' 실패');
      return r.json();
    }

    /*** 필드 렌더/수집 ***/
    function pickInputType(title){
      if (title.includes('메일')) return 'email';
      if (title.includes('연락처') || title.includes('전화')) return 'tel';
      if (title.includes('생년') || title.includes('생일')) return 'date';
      return 'text';
    }
    function renderFields(fields, prevValues){
      const container = $('#fields'); container.innerHTML = '';
      fields.forEach(f=>{
        const id = 'f_' + f.title;
        const val = prevValues?.[f.title] ?? '';
        const type = pickInputType(f.title);
        const el = document.createElement('div');
        el.className = 'field';
        el.innerHTML = `
          <label class="label" for="${id}">${f.title}</label>
          <input class="input" id="${id}" name="${f.title}" type="${type}" value="${escapeHtml(val)}" />
        `;
        container.appendChild(el);
      });
    }
    function collectValues(){
      const values = {};
      CONFIG_FIELDS.forEach(f=>{
        const el = document.getElementById('f_'+f.title);
        values[f.title] = el ? el.value : '';
      });
      return values;
    }

    /*** 앱 로드 ***/
    async function afterLogin(){
      if (!LOGIN?.email) { showLogin(); return; }
      $('#loginInfo').innerHTML =
        `<div>${escapeHtml(LOGIN.name || LOGIN.email)}</div><div class="muted">${escapeHtml(LOGIN.email)}</div>`;
      showApp();
      await initApp();
    }

    async function initApp(){
      try{
        disableButtons(true);

        // ⚡ config와 draft를 동시에 요청
        const [cfg, draft] = await Promise.all([
          fetchConfig(),
          fetchDraft(LOGIN.email)
        ]);

        CONFIG_FIELDS = cfg.fields || [];
        CONFIG_IMAGE  = (cfg.headerImageUrl || '').trim();

        const imgEl = $('#headerImage');
        if (CONFIG_IMAGE) {
          imgEl.src = CONFIG_IMAGE;        // 이미지에는 캐시버스터 사용 X
          imgEl.style.display = 'block';
        } else {
          imgEl.removeAttribute('src');
          imgEl.style.display = 'none';
        }
        imgEl.onerror = () => { imgEl.style.display = 'none'; };

        renderFields(CONFIG_FIELDS, draft?.values || {});
      }catch(e){ console.error(e); toast('초기화 실패'); }
      finally{ disableButtons(false); }
    }

    /*** 이벤트 ***/
    $('#btnDraft').addEventListener('click', async ()=>{
      try{
        if(!LOGIN?.email) return toast('로그인이 필요합니다.');
        disableButtons(true);
        await postAction('save', LOGIN.email, CONFIG_FIELDS, collectValues());
        toast('임시 저장되었습니다.');
      }catch(e){ console.error(e); toast('임시 저장 실패'); }
      finally{ disableButtons(false); }
    });
    $('#btnSubmit').addEventListener('click', async ()=>{
      try{
        if(!LOGIN?.email) return toast('로그인이 필요합니다.');
        disableButtons(true);
        await postAction('submit', LOGIN.email, CONFIG_FIELDS, collectValues());
        toast('최종 제출 완료');
      }catch(e){ console.error(e); toast('제출 실패'); }
      finally{ disableButtons(false); }
    });
    $('#btnSignOut').addEventListener('click', ()=>{ signOut(); });
  </script>
</body>
</html>

